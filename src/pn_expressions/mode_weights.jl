# This function is stolen from SphericalFunctions.jl
@inline Yindex(â„“, m, â„“â‚˜áµ¢â‚™=0) = â„“*(â„“ + 1) - â„“â‚˜áµ¢â‚™^2 + m + 1

"""
    h!(h, pnstate; â„“min=0, â„“max=typemax(Int))
    mode_weights!(h, pnstate; â„“min=0, â„“max=typemax(Int))

Compute mode weights of gravitational waves emitted by `pn` system, modifying `h` in place.

These modes are computed in the "co-orbital" frame, in which the larger object lies on the
positive ``x`` axis, the smaller lies on the negative ``x`` axis, and the instantaneous
angular velocity is in the positive ``z`` direction.

The modes are stored in `h` in order of increasing ``â„“`` and increasing ``m``, with ``m``
iterating fastest, all the way up to the highest available mode, ``(8,8)``.

Because gravitational waves have spin weight -2, the ``(â„“,m)=(0,0)``, ``(1,-1)``, ``(1,0)``,
and ``(1,1)`` modes are always 0.  By default, we assume that these modes are nonetheless
included in `h`.  If that is not the case, set `â„“min` to the smallest ``â„“`` value that
should be present in the output data â€” `â„“min=2` being the most reasonable alternative.

All non-spinning terms are taken from [Blanchet
(2014)](https://doi-org.proxy.library.cornell.edu/10.12942/lrr-2014-2).  The 1PN spin-orbit
term is from Eq. (3.22d) of [Kidder
(1995)](https://link.aps.org/doi/10.1103/PhysRevD.52.821).  The 1.5PN spin-orbit term is
from Eq. (3.22f) of Kidder (1995) and Eq. (F15b) of [Will and Wiseman
(1996)](https://link.aps.org/doi/10.1103/PhysRevD.54.4813).  The 2PN spin-orbit term is from
Eq. (4.13) of [Buonanno, Faye, Hinderer
(2013)](https://link.aps.org/doi/10.1103/PhysRevD.87.044009), while the 2PN spin-spin term
is from Eq. (4.15) of that reference.
"""
@compute_pn_variables 2 function h!(h, pnstate{T}; â„“min=0, â„“max=typemax(Int)) where T
    h .= false  # Set everything to 0 just to be safe

    let âˆš(x) = âˆšT(x)

        c = 2Î½ * v^2 * âˆš(16Ï€/5)

        # ell=2
        if â„“maxâ‰¥2
            h[Yindex(2,0,â„“min)] = c * (-5/(14âˆš6))
            h[Yindex(2,1,â„“min)] = c * (
                v^1 * (ğ’¾ * Î´ / 3)
                + v^3 * (ğ’¾ * Î´ * (-17 + 20Î½) / 84)
                + v^4 * ((Î´ * (1 + 2ğ’¾*Ï€ + 4log2)) / 6)
                + v^5 * (ğ’¾ * Î´ * (-172 + Î½ * (-2036 + 237Î½)) / 1512)
                + v^6 * (Î´*(-34ğ’¾*Ï€ - 17*(1 + 4log2) + 2Î½ * (353 + 6ğ’¾*Ï€ + 12log2)) / 168)
            )
            h[Yindex(2,2,â„“min)] = c * (
                1
                + v^2 * ((-107 + 55Î½)/42)
                + v^3 * (2Ï€)
                + v^4 * ((-2173 + Î½ * (-7483 + 2047Î½)) / 1512)
                + v^5 * (-24ğ’¾*Î½ + ((-107 + 34Î½)Ï€) / 21)
                + v^6 * (
                    (27027409//646800) - 856Î³â‚‘/105 + (Î½*(-834555 + Î½*(-729396 + 114635Î½))) / 99792
                    + 41Î½ * Ï€^2 / 96 + (2Ï€*(214ğ’¾ + 35Ï€))/105 - 1712log2/105
                    - (856//105)*logv
                )
                + v^7 * ((-2ğ’¾ * Î½ * (-501655 + 24396Î½) + 15*(-2173 + 2Î½*(-2459 + 560Î½))Ï€) / 11340)
            )
        end

        # ell=3
        if â„“maxâ‰¥3
            h[Yindex(3,0,â„“min)] = c * v^5 * (-2ğ’¾ * âˆš(6//7) * Î½ / 5)
            h[Yindex(3,1,â„“min)] = c * (
                v^1 * (ğ’¾ * Î´ / 12âˆš14)
                + v^3 * (-ğ’¾ * Î´ * (4 + Î½) / 18âˆš14)
                + v^4 * (Î´ * (7 + 5ğ’¾*Ï€ + 10log2) / 60âˆš14)
                + v^5 * (-ğ’¾ * Î´ * (-607 + Î½*(272 + 247Î½)) / 2376âˆš14)
                + v^6 * (
                    Î´ * (-5ğ’¾ * (16 + 7Î½)Ï€ + 2*(-56 + Î½ - 5*(16 + 7Î½)*log2)) / 360âˆš14
                )
                + v^7 * (
                    ğ’¾ * Î´ / 12âˆš14 * (
                        (10753397//1513512) - 2log2*((212//105) + log2) - (26//21)*Î³â‚‘ + (Ï€^2/6)
                        - 2ğ’¾*Ï€*((41//105) + log2) + (Î½/8)*(-(1738843//19305) + (41//8)*Ï€^2)
                        + (327059//30888)*Î½^2 - (17525//15444)*Î½^3
                        + logv * (-26//21)
                    )
                )
            )
            h[Yindex(3,2,â„“min)] = c * (
                v^2 * (âˆš(5//7) * (1 - 3Î½) / 3)
                + v^4 * ((-193 + (145 - 73Î½)*5Î½) / 54âˆš35)
                + v^5 * ((-15ğ’¾ + 66ğ’¾*Î½ + 10Ï€ - 30Ï€*Î½) / 3âˆš35)
                + v^6 * ((-1451 + (-17387 + 3*(33342 - 5341Î½)Î½)Î½) / 2376âˆš35)
            )
            h[Yindex(3,3,â„“min)] = c * (
                v^1 * (-3ğ’¾ * âˆš(15//224) * Î´)
                + v^3 * (-3ğ’¾ * âˆš(15//56) * Î´ * (-2 + Î½))
                + v^4 * (âˆš(243//70) * Î´ * (-7 - 5ğ’¾*Ï€ + 10logÂ³â•±â‚‚) / 4)
                + v^5 * (-ğ’¾ * âˆš(3//542080) * Î´ * (369 + (-3676 + 887Î½)Î½))
                + v^6 * (Î´ * (-3645ğ’¾ * (-8 + 3Î½)Ï€ + (40824 - 96206Î½ + 7290*(-8 + 3Î½)logÂ³â•±â‚‚)) / 216âˆš210)
                + v^7 * (
                    ((-3ğ’¾)/4) * âˆš(15//14) * Î´ * (
                        (19388147//280280) + (492//35)logÂ³â•±â‚‚ - 18*logÂ³â•±â‚‚^2 - (78//7)Î³â‚‘ + (3//2)Ï€^2
                        + 6ğ’¾ * Ï€ * (-41//35 + 3logÂ³â•±â‚‚)
                        + (-7055//3432 + 41//64 * Ï€^2)Î½ - (318841//17160)Î½^2 + (8237//2860)Î½^3
                        + logv * (-(39//7) * 4log2)
                    )
                )
            )
        end

        # ell=4
        if â„“maxâ‰¥4
            h[Yindex(4,0,â„“min)] = c * (-1 / 504âˆš2)
            h[Yindex(4,1,â„“min)] = c * (
                v^3 * (ğ’¾ * Î´ * (1 - 2Î½) / 84âˆš10)
                + v^5 * (-ğ’¾ * Î´ * (404 + (-1011 + 332Î½)Î½) / 11088âˆš10)
                + v^6 * (Î´ * (64 - 1661Î½ - 30ğ’¾*(-1 + 2Î½)Ï€ + 60*(1 - 2Î½)log2) / 2520âˆš10)
            )
            h[Yindex(4,2,â„“min)] = c * (
                v^2 * (âˆš5 * (1 - 3Î½) / 63)
                + v^4 * ((-1311 + 5*(805 - 57Î½)Î½) / 4158âˆš5)
                + v^5 * ((-21ğ’¾ + Î½*(84ğ’¾ - 30Ï€) + 10Ï€) / 63âˆš5)
                + v^6 * ((9342351 + 7Î½*(-5460759 + 115Î½*(34822 + 3363Î½))) / 22702680âˆš5)
            )
            h[Yindex(4,3,â„“min)] = c * (
                v^3 * (9ğ’¾ * Î´ * (-1 + 2Î½) / 4âˆš70)
                + v^5 * (3ğ’¾ * Î´ * (468 + (-1267 + 524Î½)Î½) / 176âˆš70)
                + v^6 * (Î´ * (-5184 + 16301Î½ + 2430ğ’¾*(-1 + 2Î½)Ï€ + 4860*(1 - 2Î½)logÂ³â•±â‚‚) / 360âˆš70)
            )
            h[Yindex(4,4,â„“min)] = c * (
                v^2 * (8 * âˆš(5//7) * (-1 + 3Î½) / 9)
                + v^4 * (4 * (1779 + 5Î½*(-1273 + 525Î½)) / 297âˆš35)
                + v^5 * ((160*(-1 + 3Î½)Ï€ + ğ’¾*(336 - 1193Î½ + 320*(-1 + 3Î½)log2)) / 9âˆš35)
                + v^6 * ((-9618039 + 7Î½*(9793071 + 5Î½*(-3231338 + 678291Î½))) / 405405âˆš35)
            )
        end

        # ell=5
        if â„“maxâ‰¥5
            h[Yindex(5,1,â„“min)] = c * (
                v^3 * (ğ’¾ * Î´ * (1 - 2Î½) / 288âˆš385)
                + v^5 * (-ğ’¾ * Î´ * (179 + 4*(-88 + Î½)Î½) / 11232âˆš385)
                + v^6 * (Î´ * (181 - 70ğ’¾*(-1 + 2Î½)Ï€ + 140log2 - 28Î½*(313 + 10log2)) / 20160âˆš385)
            )
            h[Yindex(5,2,â„“min)] = c * (
                v^4 * ((2 + 10*(-1 + Î½)Î½) / 27âˆš55)
                + v^6 * ((-3911 + 7Î½*(3079 + 35Î½*(-118 + 33Î½))) / 12285âˆš55)
            )
            h[Yindex(5,3,â„“min)] = c * (
                v^3 * (9ğ’¾ * âˆš(3//110) * Î´ * (-1 + 2Î½) / 32)
                + v^5 * (3ğ’¾ * âˆš(3//110) * Î´ * (207 + 8Î½*(-58 + 11Î½)) / 416)
                + v^6 * (Î´ * (-395847 + 1171828Î½ + 153090ğ’¾*(-1 + 2Î½)Ï€ - 306180*(-1 + 2Î½)*logÂ³â•±â‚‚) / 60480âˆš330)
            )
            h[Yindex(5,4,â„“min)] = c * (
                v^4 * ((-32 - 160*(-1 + Î½)Î½) / 9âˆš165)
                + v^6 * (16*(4451 - 7Î½*(3619 + 5Î½*(-1042 + 339Î½))) / 4095âˆš165)
            )
            h[Yindex(5,5,â„“min)] = c * (
                v^3 * (-625ğ’¾ * Î´ * (-1 + 2Î½) / 96âˆš66)
                + v^5 * (-625ğ’¾ * Î´ * (263 + 16Î½*(-43 + 16Î½)) / 3744âˆš66)
                + v^6 * (Î´ * (565625 - 1481676Î½ - 218750ğ’¾*(-1 + 2Î½)Ï€ + 437500*(-1 + 2Î½)logâµâ•±â‚‚) / 6720âˆš66)
            )
        end

        # ell=6
        if â„“maxâ‰¥6
            h[Yindex(6,1,â„“min)] = c * v^5 * (ğ’¾ * Î´ * (-1 + Î½) * (-1 + 3 * Î½) / 8316âˆš26)
            h[Yindex(6,2,â„“min)] = c * (
                v^4 * ((2 + (-1 + Î½) * 10Î½) / 297âˆš65)
                + v^6 * ((-81 + (59 + (-64 + 7Î½)Î½) * 7Î½) / 2079âˆš65)
            )
            h[Yindex(6,3,â„“min)] = c * v^5 * (-81ğ’¾ * Î´ * (-1 + Î½) * (-1 + 3Î½) / 616âˆš65)
            h[Yindex(6,4,â„“min)] = c * (
                v^4 * (-128 * âˆš(2//39) * (1 + 5 * (-1 + Î½)Î½) / 495)
                + v^6 * (-64 * âˆš(2//39) * (-93 + 7 * (71 + (-88 + 19Î½)Î½)Î½) / 3465)
            )
            h[Yindex(6,5,â„“min)] = c * v^5 * (3125ğ’¾ * Î´ * (-1 + Î½) * (-1 + 3Î½) / 504âˆš429)
            h[Yindex(6,6,â„“min)] = c * (
                v^4 * (54 * (1 + 5 * (-1 + Î½)Î½) / 5âˆš143)
                + v^6 * (27 * (-113 + 7 * (91 + (-128 + 39Î½)Î½)Î½) / 35âˆš143)
            )
        end

        # ell=7
        if â„“maxâ‰¥7
            h[Yindex(7,1,â„“min)] = c * v^5 * (ğ’¾ * Î´ * (-1 + Î½) * (-1 + 3Î½) / 864864âˆš2)
            h[Yindex(7,2,â„“min)] = c * v^6 * ((1 - (-1 + Î½)^2 * 7Î½) / 3003âˆš3)
            h[Yindex(7,3,â„“min)] = c * v^5 * (-243ğ’¾ * âˆš(3//2) * Î´ * (-1 + Î½) * (-1 + 3Î½) / 160160)
            h[Yindex(7,4,â„“min)] = c * v^6 * (128âˆš(2//33) * (-1 + (-1 + Î½)^2 * 7Î½) / 1365)
            h[Yindex(7,5,â„“min)] = c * v^5 * (15625ğ’¾ * Î´ * (-1 + Î½) * (-1 + 3Î½) / 26208âˆš66)
            h[Yindex(7,6,â„“min)] = c * v^6 * (-81âˆš(3//143) * (-1 + (-1 + Î½)^2 * 7Î½) / 35)
            h[Yindex(7,7,â„“min)] = c * v^5 * (-16807ğ’¾ * âˆš(7//858) * Î´ * (-1 + Î½) * (-1 + 3Î½) / 1440)
        end

        # ell=8
        if â„“maxâ‰¥8
            h[Yindex(8,2,â„“min)] = c * v^6 * (-(-1 + (-1 + Î½)^2 * 7Î½) / 9009âˆš85)
            h[Yindex(8,4,â„“min)] = c * v^6 * ((128âˆš(2//187) * (-1 + (-1 + Î½)^2 * 7Î½)) / 4095)
            h[Yindex(8,6,â„“min)] = c * v^6 * ((-243âˆš(3//17017) * (-1 + (-1 + Î½)^2 * 7Î½)) / 35)
            h[Yindex(8,8,â„“min)] = c * v^6 * ((16384âˆš(2//85085) * (-1 + (-1 + Î½)^2 * 7Î½)) / 63)
        end

        # Symmetric spin terms
        if â„“maxâ‰¥2
            h[Yindex(2,0,â„“min)] += c * v^4 * -((Mâ‚‚*(Sâ‚Î» - Sâ‚â‚™) + Mâ‚*(Sâ‚‚Î» - Sâ‚‚â‚™)) * (Mâ‚‚*(Sâ‚Î» + Sâ‚â‚™) + Mâ‚*(Sâ‚‚Î» + Sâ‚‚â‚™))) / (âˆš6 * M^4 * Î½^2)
            h[Yindex(2,1,â„“min)] += c * v^2 * (ğ’¾ * Î£â‚— / 2M^2)
            h[Yindex(2,1,â„“min)] += c * v^4 * (ğ’¾ * (-86*Sâ‚—*Î´ + Î£â‚—*(139Î½ - 79)) / 42M^2)
            h[Yindex(2,2,â„“min)] += c * v^3 * (-(6Sâ‚— + 2Î£â‚—*Î´) / 3M^2)
            h[Yindex(2,2,â„“min)] += c * v^4 * (
                Mâ‚‚^2 * (6Sâ‚â‚—^2 + 5Sâ‚Î»^2 - 15ğ’¾*Sâ‚Î»*Sâ‚â‚™ - 11Sâ‚â‚™^2)
                + Mâ‚*Mâ‚‚ * (12Sâ‚â‚—*Sâ‚‚â‚— + 10Sâ‚Î»*Sâ‚‚Î» - 15ğ’¾*Sâ‚â‚™*Sâ‚‚Î» - 15ğ’¾*Sâ‚Î»*Sâ‚‚â‚™ - 22Sâ‚â‚™*Sâ‚‚â‚™)
                + Mâ‚^2 * (6Sâ‚‚â‚—^2 + 5Sâ‚‚Î»^2 - 15ğ’¾*Sâ‚‚Î»*Sâ‚‚â‚™ - 11Sâ‚‚â‚™^2)
            ) / (6M^4 * Î½^2)
        end
        if â„“maxâ‰¥3
            h[Yindex(3,1,â„“min)] += c * v^4 * (âˆš14ğ’¾ * (Sâ‚—*Î´ - 5Î£â‚—*(3Î½ - 1)) / 336M^2)
            h[Yindex(3,2,â„“min)] += c * v^3 * (2âˆš35 * (Sâ‚— + Î£â‚—*Î´) / 21M^2)
            h[Yindex(3,3,â„“min)] += c * v^4 * (3âˆš210ğ’¾ * (7Sâ‚—*Î´ - 3Î£â‚—*(3Î½ - 1)) / 112M^2)
        end
        if â„“maxâ‰¥4
            h[Yindex(4,1,â„“min)] += c * v^4 * (âˆš10ğ’¾ * (Sâ‚—*Î´ - 3Î£â‚—*Î½ + Î£â‚—) / 336M^2)
            h[Yindex(4,3,â„“min)] += c * v^4 * (9âˆš70ğ’¾ * (-Sâ‚—*Î´ + 3Î£â‚—*Î½ - Î£â‚—) / 112M^2)
        end

        # Symmetrize everything
        for â„“ in 2:â„“max
            for m in 1:â„“
                h[Yindex(â„“,-m,â„“min)] = ifelse(isodd(â„“), -1, 1) * conj(h[Yindex(â„“,m,â„“min)])
            end
        end

        # Anti-symmetric spin terms
        if â„“maxâ‰¥2
            hÌƒ_2_0 = c * (
                v^2 * (âˆš6ğ’¾ * Î£â‚™ / 6M^2)
                + v^4 * (âˆš6ğ’¾ * (255Sâ‚™*Î´ - Î£â‚™*(506Î½ - 45)) / 126M^2)
            )
            h[Yindex(2,0,â„“min)] += hÌƒ_2_0
            hÌƒ_2_1 = c * (
                v^3 * ((4ğ’¾*SÎ» + 25*Sâ‚™ + 4ğ’¾*Î£Î»*Î´ + 13*Î£â‚™*Î´) / 6M^2)
                + v^4 * -3 * (Mâ‚‚*Sâ‚â‚— + Mâ‚*Sâ‚‚â‚—) * (Mâ‚‚*Sâ‚â‚™ + Mâ‚*Sâ‚‚â‚™) / (2M^4 * Î½^2)
            )
            h[Yindex(2,1,â„“min)] += hÌƒ_2_1
            h[Yindex(2,-1,â„“min)] += -conj(hÌƒ_2_1)
            hÌƒ_2_2 = c * (
                v^2 * (-(Î£Î» + ğ’¾*Î£â‚™) / 2M^2)
                + v^4 * ((19*SÎ»*Î´ + 182ğ’¾*Sâ‚™*Î´ - 43*Î£Î»*Î½ + 5*Î£Î» - 280ğ’¾*Î£â‚™*Î½ + 98ğ’¾*Î£â‚™) / 84M^2)
            )
            h[Yindex(2,2,â„“min)] += hÌƒ_2_2
            h[Yindex(2,-2,â„“min)] += -conj(hÌƒ_2_2)
        end
        if â„“maxâ‰¥3
            hÌƒ_3_0 = c * v^4 * (âˆš42 * (-17SÎ»*Î´ + Î£Î»*(35Î½ - 9)) / 168M^2)
            h[Yindex(3,0,â„“min)] += hÌƒ_3_0
            hÌƒ_3_1 = c * v^3 * (âˆš14 * (ğ’¾*SÎ» + Sâ‚™ + Î´*(ğ’¾*Î£Î» + Î£â‚™)) / 21M^2)
            h[Yindex(3,1,â„“min)] += hÌƒ_3_1
            h[Yindex(3,-1,â„“min)] += conj(hÌƒ_3_1)
            hÌƒ_3_2 = c * v^4 * (âˆš35 * (-Î£Î»*(83Î½ - 17) + 4ğ’¾*Î£â‚™*(55Î½ - 13) + 25Î´ * (SÎ» - 4ğ’¾*Sâ‚™)) / 168M^2)
            h[Yindex(3,2,â„“min)] += hÌƒ_3_2
            h[Yindex(3,-2,â„“min)] += conj(hÌƒ_3_2)
            hÌƒ_3_3 = c * v^3 * (âˆš210ğ’¾ * (SÎ» + ğ’¾*Sâ‚™ + Î´*(Î£Î» + ğ’¾*Î£â‚™)) / 21M^2)
            h[Yindex(3,3,â„“min)] += hÌƒ_3_3
            h[Yindex(3,-3,â„“min)] += conj(hÌƒ_3_3)
            hÌƒ_4_0 = c * v^4 * (âˆš2ğ’¾ * (Sâ‚™*Î´ - 3Î£â‚™*Î½ + Î£â‚™) / 168M^2)
        end
        if â„“maxâ‰¥4
            h[Yindex(4,0,â„“min)] += hÌƒ_4_0
            hÌƒ_4_2 = c * v^4 * (âˆš5 * (-13Î£Î»*(3Î½ - 1) + 14ğ’¾*Î£â‚™*(3Î½ - 1) + Î´*(13SÎ» - 14ğ’¾*Sâ‚™)) / 168M^2)
            h[Yindex(4,2,â„“min)] += hÌƒ_4_2
            h[Yindex(4,-2,â„“min)] += -conj(hÌƒ_4_2)
            hÌƒ_4_4 = c * v^4 * (9âˆš35 * (-3Î£Î»*Î½ + Î£Î» - ğ’¾*Î£â‚™*(3Î½ - 1) + Î´*(SÎ» + ğ’¾*Sâ‚™)) / 56M^2)
            h[Yindex(4,4,â„“min)] += hÌƒ_4_4
            h[Yindex(4,-4,â„“min)] += -conj(hÌƒ_4_4)
        end
    end

    h
end
const mode_weights! = h!
